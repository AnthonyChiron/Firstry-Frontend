<confirmation-modal
  [isVisible]="showDeleteModal"
  title="Danger zone !"
  message="
    Voulez-vous vraiment supprimer la catégorie {{ this.category.name }} ?
  "
  (confirmed)="onDeleteConfirmed()"
  (cancelled)="onDeleteCancelled()"
></confirmation-modal>
<div class="main">
  <card
    [title]="
      categoryForm.get('name').value && !isNew
        ? categoryForm.get('name').value + ' - ' + category.sports
        : 'Création de catégorie'
    "
    class="category"
    color="2"
    size="s"
    [toggleBtn]="true"
    [toggle]="true"
    *ngIf="category"
  >
    <div header>
      <div class="topBtns" *ngIf="!isNew">
        <btn
          type="transparent"
          *ngIf="edit"
          label="Supprimer la catégorie"
          (click)="showDeleteModal = true"
          class="deleteBtn"
        ></btn>
        <btn
          *ngIf="!edit"
          type="transparent"
          icon="fa-solid fa-pen-to-square fa-lg"
          (click)="edit = !edit"
          class="editBtn"
        ></btn>
      </div>
    </div>

    <form [formGroup]="categoryForm">
      <input-text
        *ngIf="isNew"
        name="name"
        type="Text"
        placeholder="Nom..."
        label="Nom de la catégorie"
        formControlName="name"
        [edit]="edit"
        [error]="
          touched &&
          (fus.isFieldInvalid('name') || categoryForm.get('name').value == '')
        "
      ></input-text>

      <input-textarea
        name="description"
        type="Text"
        placeholder="Description..."
        label="Description"
        formControlName="description"
        [edit]="edit"
        [error]="
          touched &&
          (fus.isFieldInvalid('description') ||
            categoryForm.get('description').value == '')
        "
      >
      </input-textarea>

      <div *ngIf="contest.sports.length > 1" class="inputGroup">
        <h4>Disciplines</h4>
        <chips-group
          [chips]="sports"
          formControlName="sports"
          [edit]="edit"
        ></chips-group>
        <note
          *ngIf="
            touched &&
            (fus.isFieldInvalid('sports') ||
              categoryForm.get('sports').value == '')
          "
          type="error"
          text="Veuillez choisir au moins un sport !"
        >
        </note>
      </div>
      <div class="inscription flexRow">
        <input-text
          class="maxRiders"
          name="maxRiders"
          type="number"
          placeholder="Nombre de riders maximum..."
          label="Nombre de riders maximum"
          formControlName="maxRiders"
          [edit]="edit"
          [error]="
            touched &&
            (fus.isFieldInvalid('maxRiders') ||
              categoryForm.get('maxRiders').value == '')
          "
        ></input-text>

        <!-- registerPrice input -->
        <input-text
          class="registerPrice"
          name="registerPrice"
          type="number"
          placeholder="Prix d'inscription..."
          label="Prix d'inscription"
          formControlName="registerPrice"
          [edit]="edit"
          [error]="
            touched &&
            (fus.isFieldInvalid('registerPrice') ||
              categoryForm.get('registerPrice').value == '')
          "
        ></input-text>

        <slide-input
          class="qualificationStep"
          name="isQualificationStep"
          formControlName="isQualificationStep"
          label="Qualification ?"
          [edit]="edit"
          (click)="toggleQualificationStep()"
        ></slide-input>
      </div>

      <div class="steps">
        <h4>Étapes</h4>
        <div class="stepsList">
          <card
            *ngIf="categoryForm.value.isQualificationStep"
            color="3"
            size="s"
            class="step"
          >
            <div formGroupName="stepQualif">
              <h4>Qualification</h4>
              <input-text
                type="number"
                label="Nombre de riders par poule"
                formControlName="ridersPerPool"
                [edit]="edit"
                [error]="
                  touched &&
                  categoryForm.get('stepQualif').get('ridersPerPool').invalid
                "
              ></input-text>
              <input-text
                type="number"
                label="Nombre de riders qualifié.es"
                formControlName="ridersQualifiedCount"
                [edit]="edit"
                [error]="
                  touched &&
                  categoryForm.get('stepQualif').get('ridersQualifiedCount')
                    .invalid
                "
              ></input-text>
              <dropdown
                name="rules"
                formControlName="rules"
                label="Règle de l'étape"
                [options]="rulesOptions"
                [edit]="edit"
              ></dropdown>
            </div>
          </card>
          <card color="3" size="s" class="step">
            <div formGroupName="stepFinal">
              <h4 *ngIf="categoryForm.value.isQualificationStep">Finale</h4>
              <input-text
                type="number"
                label="Nombre de riders par poule"
                formControlName="ridersPerPool"
                [edit]="edit"
                [error]="
                  touched &&
                  categoryForm.get('stepFinal').get('ridersPerPool').invalid
                "
              ></input-text>
              <dropdown
                name="rules"
                formControlName="rules"
                label="Règle de l'étape"
                [options]="rulesOptions"
                [edit]="edit"
              ></dropdown>
            </div>
          </card>
        </div>
      </div>

      <div class="buttons" *ngIf="edit">
        <btn
          (click)="cancel()"
          label="Annuler"
          icon="fa-solid fa-xmark"
          iconPos="right"
        ></btn>

        <btn
          (click)="submit()"
          label="Valider"
          icon="fa-solid fa-check"
          iconPos="right"
        ></btn>
      </div>
    </form>
  </card>
</div>
